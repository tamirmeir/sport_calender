# Sport Calendar - Architecture & API Usage Guide

## 1. System Architecture

The system operates as a hybrid application using **Node.js** for data aggregation and **Python** for user management and calendar synchronization.

### Service Responsibilities
*   **Node.js (Data Gateway)**: `src/index.js`
    *   Handles all interactions with API-Sports (Football API).
    *   Implements aggressive caching (Memory + File-based).
    *   Executes complex logic to determine "Active Teams" in tournaments.
    *   Serves the static frontend assets (`public/`).
*   **Python (User & Sync Engine)**: `backend/app.py`
    *   Manages User Authentication (JWT).
    *   Stores User Preferences (SQLite: `instance/sport_calendar.db`).
    *   Generates the `.ics` calendar feeds for Google Calendar/Outlook.
    *   Handles the Calendar sync logic (status updates, location).

### Data Flow
1.  **User Selects League**: Frontend -> Node.js (`sw.js` cache -> `footballApi.js` -> API-Sports).
2.  **User Selects Team**: Frontend -> Node.js (Active Team Funnel).
3.  **User Saves Fixture**: Frontend -> Python (`/api/calendar/add`).
4.  **Google Calendar Sync**: Google -> Python (`/sync/MatchDayByTM/<user>.ics`).

---

## 2. API-Sports Data Usage Strategy

We utilize the **API-Sports Football V3** endpoints. Below is the mapping of specific attributes to our system's logic.

### A. Critical Attributes (The "Must-Haves")

| API Field | Our Usage | Criticality |
|-----------|-----------|-------------|
| `fixture.id` | **Primary Key / UID**. Used as the unique identifier in our DB (`saved_fixtures.fixture_id`) and as the `UID` in the generated ICS file. Ensures calendar events are updated, not duplicated. | ðŸš¨ High |
| `fixture.status.short` | **Status Logic**. <br>- `NS` (Not Started): Standard scheduled game.<br>- `PST` (Postponed): Triggers an immediate update to the Calendar. <br>- `FT`/`1H`/`HT`: Used to append scores to the event title. | ðŸš¨ High |
| `feature.timestamp` | **Time Anchor**. Converted to `DTSTART` in the ICS file. Used to place the event on the correct day/time. | ðŸš¨ High |

### B. Grouping & Discovery (The "Navigator")

| API Field | Our Usage |
|-----------|-----------|
| `league.id` | **Grouping Key**. Used to filter fixtures and manage user subscriptions. Allows users to say "I only want CL matches". |
| `league.standings` | **UX Flag**. Before rendering a "View Standings" button, we check this boolean. If `false`, the button is hidden to prevent empty states. |
| `fixture.venue.id` | **Asset Mapping**. Used to fetch specific venue images if needed. |

### C. Visual Assets (The "UI Experience")

| API Field | Our Usage | Optimization |
|-----------|-----------|--------------|
| `teams.home.logo` | **Direct Linking**. We do *not* download images. We inject the CDN URL directly into the `<img>` tags. | Saves Storage/BW |
| `teams.away.logo` | **Direct Linking**. Same as above. | Saves Storage/BW |

### D. Location & Context (The "Calendar Richness")

| API Field | Our Usage | Target Output |
|-----------|-----------|---------------|
| `fixture.venue.name` | **Event Location**. Combined with City. | ICS `LOCATION:` field |
| `fixture.venue.city` | **Event Location**. | ICS `LOCATION:` field |

---

## 3. Database Schema (Python/SQLite)

The backend uses SQLAlchemy. Key tables:

1.  **User**: `id`, `username`, `email`.
2.  **SavedFixture**:
    *   `fixture_id`: The API-Sports ID.
    *   `fixture_data`: JSON blob of the *last known state* of the match. Used for offline generation and change detection.
3.  **FavoriteTeam**: `team_id`, `team_name`, `team_logo`.

## 4. "Active Teams" Algorithm (Node.js)

To solve the issue of "Empty Team Lists" in Cups (like Champions League) or Future Tournaments (WC 2026), we use a **4-Phase Funnel**:

1.  **Phase 1**: Fetch `NS` (Not Started) fixtures for the current season. Extract distinct Team IDs.
2.  **Phase 2**: If count is low (<4), fetch `Standings` and extract Team IDs.
3.  **Phase 3**: If still low, fetch `Last 20 Results` and extract Team IDs.
4.  **Phase 4 (Nuclear)**: If distinct count is still 0 (e.g., WC 2026 far in active), fetch the standard "Team List" endpoint.

*Result*: A robust list of actually participating teams, preventing empty selection screens.

## 5. League Validity (The Heartbeat)

We maintain a local cache of "Active Leagues" (`src/data/active_leagues.json`) generated by `src/scripts/verify_leagues.js`. This script checks:
1. Does the league have fixtures?
2. Does the league have standings?
3. Is it truly "Current"?

This prevents "Zombie Leagues" (technically current season, but no data) from appearing in the UI.
